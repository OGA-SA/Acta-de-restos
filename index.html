<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Acta de restos</title>
  <link rel="stylesheet" href="estilo.css" />
</head>
<body>
  <div id="escalado">
    <div id="contenidoPDF">
      <h2 style="color: #FFFFFF;">INFORME DE LIQUIDACIÓN DE RESTOS</h2>

      <div class="datos">
          <form class="columna izq">
             <div class="lugar">
              <!-- ✅ La fecha ahora se maneja aquí -->
              <div id="fecha"></div>
                 <label><span>Lugar de Inspección</span> <input type="text" id="ubicación" required /></label>
                 <label><span>Localidad</span> <input type="text" id="localidad" required /></label>
               </div>

            <div class="info-auto"> 
                <label id="marca"><span>Marca</span> <input type="text" required /> <span>Año</span> <input type="text" required /></label>
                <label><span>Modelo</span> <input type="text" id="modelo" required /></label>
                <label><span>Chasis</span> <input type="text" id="chasis" required /></label>
            </div>
            </form>

          <form class="columna der">
            <div class="derecha">
              <div class="siniestro">
                <label class="stro-año"> 
                    <span>Siniestro:</span>
                    <input type="text" id="siniestro1" required />             
                    <span>Año:</span>
                    <input type="text" id="siniestro2" 
                           min="1900" max="2100" 
                           required  
                           placeholder="XXXX" 
                           title="Debe ingresar el año completo con 4 dígitos (ej: 2025)"
                           pattern="\d{4}" />
                  </label>
                <label><span>Matrícula</span> <input type="text" id="matrícula" required /></label>
            </div>
          <div class="color">
                <label><span>Color</span> <input type="text" id="color" required /></label>
                <label><span>Motor</span> <input type="text" id="Motor" required /></label>
                <label><span>Tipo de cambio</span> <input type="text" id="cambio" required /></label>
          </form>
              </div>
          </div>

      </div>
      <div class="tablas"> 
        <table id="tablaValor"> 
          <thead> 
            <tr> 
              <th></th> 
              <th background-color="#D6DCE4">U$S</th> 
              <th background-color="#D6DCE4">$U</th> 
            </tr> 
          </thead> 
          
          <tbody> 
            <tr><td>VALOR VENAL AUTODATA (Automóviles // Vehículos pesados)</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" />días</td></tr> 
            <tr><td>VALOR VENAL PLAZA (Motos)</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" />días</td></tr> 
            <tr><td>VALOR ESTIMADO DE LA REPARACIÓN</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" />días</td></tr> 
            <tr><td>VALOR MÍNIMO DE RESTOS</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" />días</td></tr> 
            <tr><td>DEPRECIACIONES</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" />días</td></tr> 
          </tbody> 
        </table> 
        
        <table id="tablaFinal"> 
          <tbody> 
            <tr><td>INSUMIO DESARME</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td>HORAS CORRESPONDIENTES</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td></tr> 
            <tr><td>VEHÍCULO RECUPERABLE</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td></tr> 
            <tr><td>MOTOR RECUPERABLE</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td></tr> 
          </tbody> 
        </table> 
      </div>
            
   
      
     <div class="observaciones">
                  <h2 class="Obs">OBSERVACIONES</h2>
                  <textarea id="nota" placeholder=""></textarea>
                </div>    
          
          <form id="boton">
              <div style="text-align: center; margin: 30px 0;">
                  <button class="boton" onclick="generarPDF()">Generar PDF</button>
              </div>
          </form>
  </div>
  
<!-- Librerías necesarias -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- ✅ Script para mostrar la fecha al cargar -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const fechaDiv = document.getElementById("fecha");
  if (!fechaDiv) return;

  const hoy = new Date();
  const meses = [
    "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
    "Julio", "Agosto", "Setiembre", "Octubre", "Noviembre", "Diciembre"
  ];
  const dia = hoy.getDate();
  const mes = meses[hoy.getMonth()];
  const anio = hoy.getFullYear();

  fechaDiv.innerHTML = `<b>Fecha:</b> <u>${dia} de ${mes} de ${anio}</u>`;
    });
</script>

<!-- ... (todos tus otros scripts se mantienen iguales) ... -->

<!-- ✅ Generación de PDF con fecha corregida -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const boton = document.querySelector("#boton .boton"); 
  if (!boton) {
    console.error("❌ No se encontró el botón #boton .boton");
    return;
  }

  boton.addEventListener("click", async (e) => {
    e.preventDefault();

    const carpeta = (document.getElementById("carpeta") || {}).value?.trim() || "";
    const asegurado = (document.getElementById("asegurado") || {}).value?.trim() || "";
    const vehiculo = (document.getElementById("vehiculo") || {}).value?.trim() || "";
    const matricula = (document.getElementById("matricula") || {}).value?.trim() || "";
    const siniestro1 = (document.getElementById("siniestro1") || {}).value?.trim() || "";
    const siniestro2 = (document.getElementById("siniestro2") || {}).value?.trim() || "";

    if (!carpeta || !asegurado || !vehiculo || !matricula || !siniestro1 || !siniestro2) {
      alert("⚠️ Complete todos los campos antes de generar el PDF.");
      return;
    }

    // ✅ Actualizar la fecha antes de generar PDF
    const fechaDiv = document.getElementById("fecha");
    const hoy = new Date();
    const meses = [
      "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
      "Julio", "Agosto", "Setiembre", "Octubre", "Noviembre", "Diciembre"
    ];
    const dia = hoy.getDate();
    const mes = meses[hoy.getMonth()];
    const anio = hoy.getFullYear();
    fechaDiv.innerHTML = `<b>Fecha:</b> <u>${dia} de ${mes} de ${anio}</u>`;

    const ok = confirm("¿El número de siniestro ingresado es correcto: " + siniestro1 + "-" + siniestro2 + "?");
    if (!ok) {
      return;
    }

    const element = document.getElementById("contenidoPDF");
    if (!element) {
      alert("❌ No se encontró el contenido a exportar (#contenidoPDF).");
      return;
    }

    try {
      document.body.classList.add("modo-pdf");

      const opt = {
        margin: [0, 0, 0, 0],
        filename: `${siniestro1 || "Siniestro"}-${siniestro2 || ""}.pdf`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      };

      const blob = await html2pdf().set(opt).from(element).output('blob');

      const nombreArchivo = `${siniestro1}_${siniestro2}_Formulario_1.pdf`;
      const formData = new FormData();
      formData.append('pdf', blob, nombreArchivo);
      formData.append('filename', nombreArchivo);
      formData.append("folder", "Formulario 1"); 
      
      const res = await fetch('https://extra-seguro-backend.onrender.com/upload', {
        method: 'POST',
        body: formData
      });

      if (res.ok) {
        alert("✅ PDF enviado y subido correctamente");
      } else {
        alert("❌ Error al subir PDF: " + res.status);
      }
    } catch (err) {
      alert("❌ Error generando o subiendo el PDF: " + (err?.message || err));
    } finally {
      document.body.classList.remove("modo-pdf");
    }
  });
});
</script>
</body>
</html>

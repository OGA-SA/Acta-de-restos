<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Acta de restos</title>
  <link rel="stylesheet" href="estilo.css" />
</head>
<body>
  <div id="escalado">
    <div id="contenidoPDF">
      <h2 style="color: #FFFFFF;">INFORME DE LIQUIDACIÓN DE RESTOS</h2>
      


      <div class="datos">
          <form id="columna izq">
             <div class="lugar">
              <div id="fecha"></div>
                 <label><span>Lugar de Inspección</span> <input type="text" id="ubicación" required /></label>
                 <label><span>Localidad</span> <input type="text" id="localidad" required /></label>
               </div>

            <div class="info-auto"> 
                <label><span>Marca</span> <input type="text" id="marca" required /></label>
                <label><span>Año</span> <input type="text" id="año" required /></label>
                <label><span>Modelo</span> <input type="text" id="modelo" required /></label>
                <label><span>Chasis</span> <input type="text" id="chasis" required /></label>
            </div>
            </form>

          <form id="columna der">
            <div class="stro">
                <label class="siniestro"> 
                    <span>Siniestro:</span>
                    <input type="text" id="siniestro1" required />             
                    <span>Año:</span>
                    <input type="text" id="siniestro2" 
                           min="1900" max="2100" 
                           required  
                           placeholder="XXXX" 
                           title="Debe ingresar el año completo con 4 dígitos (ej: 2025)"
                           pattern="\d{4}" />
                  </label>
                <label><span>Matrícula</span> <input type="text" id="matrícula" required /></label>
            </div>
          <div class="color">
                <label><span>Color</span> <input type="text" id="color" required /></label>
                <label><span>Motor</span> <input type="text" id="Motor" required /></label>
                <label><span>Tipo de cambio</span> <input type="text" id="cambio" required /></label>
          </form>
      </div>

      <div class="tablas">
        <table id="tablaValor">
        <thead>
          <tr>
            <th></th>
            <th>U$S</th>
            <th>$U</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>VALOR VENAL AUTODATA (Automóviles // Vehículos pesados)</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" />días</td></tr>
          <tr><td>VALOR VENAL PLAZA (Motos)</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" />días</td></tr>
          <tr><td>VALOR ESTIMADO DE LA REPARACIÓN</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" />días</td></tr>
          <tr><td>VALOR MÍNIMO DE RESTOS</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" />días</td></tr>
          <tr><td>DEPRECIACIONES</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" />días</td></tr>
          
        </tbody>
      </table>

        <table id="tablaFinal">
               <tbody>
                  <tr><td>INSUMIO DESARME</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td>HORAS CORRESPONDIENTES</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td></tr>
                  <tr><td>VEHÍCULO RECUPERABLE</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td></tr>
                  <tr><td>MOTOR RECUPERABLE</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td></tr>
                                   
                </tbody>
              </table>
    </div>
      
      <div class="observaciones">
              <h2 class="Obs">OBSERVACIONES</h2>
              <textarea class="nota" placeholder=""></textarea>
            </div>    
      
   
      <form id="boton">
          <div style="text-align: center; margin: 30px 0;">
              <button class="boton" onclick="generarPDF()">Generar PDF</button>
          </div>
        </form>
      
    </div>
    </div>
  

<!-- Librerías necesarias -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://graph.microsoft.com/v1.0/me/drive/root:/Extra Seguro/miArchivo.pdf:/content"></script>

<!-- Loader dinámico de MSAL -->
<script>
(function () {
  const candidates = [
    "https://alcdn.msauth.net/browser/2.45.0/js/msal-browser.min.js",
    "https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.45.0/lib/msal-browser.min.js",
    "https://unpkg.com/@azure/msal-browser@2.45.0/lib/msal-browser.min.js"
  ];

  function loadScript(url) {
    return new Promise((resolve, reject) => {
      const s = document.createElement("script");
      s.src = url;
      s.async = true;
      s.onload = () => resolve(url);
      s.onerror = () => reject(url);
      document.head.appendChild(s);
    });
  }

  async function ensureMsal() {
    if (window.msal) return "preloaded";
    for (const url of candidates) {
      try {
        await loadScript(url);
        if (window.msal) {
          console.log("✅ MSAL cargado desde:", url);
          return url;
        }
      } catch (e) {
        console.warn("No se pudo cargar MSAL desde:", url);
      }
    }
    throw new Error("MSAL no se pudo cargar desde ningún CDN.");
  }

  window.ensureMsal = ensureMsal;
})();
</script>

<!-- Ajuste dinámico de input -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("text");
  if (!input) return;

  input.addEventListener("input", function() {
    const span = document.createElement("span");
    span.style.visibility = "hidden";
    span.style.position = "absolute";
    span.style.whiteSpace = "pre";
    span.style.font = window.getComputedStyle(input).font;

    span.textContent = input.value || input.placeholder;

    document.body.appendChild(span);
    const ancho = span.offsetWidth + 10;
    document.body.removeChild(span);

    input.style.width = ancho + "px";
  });
});
</script>

<!-- Canvas con parabrisas -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const canvas = document.getElementById("canvas");
  if (!canvas) return;

  const ctx = canvas.getContext("2d");
  let baseImageData = null;
  window.userHasDrawn = false;

  const image = new Image();
  image.src = "parabrisa.png";
  image.onload = () => {
    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
    baseImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  };

  function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
    window.userHasDrawn = false;
    baseImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  }
  window.clearCanvas = clearCanvas;

  let drawing = false;

  function getPos(evt) {
    const rect = canvas.getBoundingClientRect();
    const escalaX = canvas.width / rect.width;
    const escalaY = canvas.height / rect.height;

    const x = evt.touches
      ? (evt.touches[0].clientX - rect.left) * escalaX
      : (evt.clientX - rect.left) * escalaX;

    const y = evt.touches
      ? (evt.touches[0].clientY - rect.top) * escalaY
      : (evt.clientY - rect.top) * escalaY;

    return { x, y };
  }

  function startDraw(evt) {
    evt.preventDefault();
    drawing = true;
    const pos = getPos(evt);
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
  }

  function draw(evt) {
    if (!drawing) return;
    evt.preventDefault();
    const pos = getPos(evt);
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "red";
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
    window.userHasDrawn = true;
  }

  function endDraw(evt) {
    evt.preventDefault();
    drawing = false;
    ctx.beginPath();
  }

  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", endDraw);
  canvas.addEventListener("mouseleave", endDraw);
  canvas.addEventListener("touchstart", startDraw, { passive: false });
  canvas.addEventListener("touchmove", draw, { passive: false });
  canvas.addEventListener("touchend", endDraw);
  canvas.addEventListener("touchcancel", endDraw);
});
</script>

  <!-- Canvas para firma -->
 <script>
document.addEventListener("DOMContentLoaded", () => {
  const canvas = document.getElementById("canvas1");
  if (!canvas) return;

  const ctx = canvas.getContext("2d");
  window.userHasDrawn = false;

  // ✅ Función para dibujar el texto "Firma:" en la esquina inferior izquierda
  function drawLabel() {
    ctx.font = "16px sans-serif";
    ctx.fillStyle = "#333";
    ctx.fillText("Firma:", 10, canvas.height - 10);
  }

  // ✅ Inicializar canvas con fondo blanco + etiqueta "Firma:"
  function initCanvas() {
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    drawLabel();
  }
  initCanvas();

  // ✅ Limpiar canvas (cuando se presiona el botón)
  function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    drawLabel(); // Redibuja "Firma:"
    window.userHasDrawn = false;
  }
  window.clearCanvas1 = clearCanvas;

  let drawing = false;

  function getPos(evt) {
    const rect = canvas.getBoundingClientRect();
    const escalaX = canvas.width / rect.width;
    const escalaY = canvas.height / rect.height;

    let x, y;
    if (evt.touches && evt.touches.length > 0) {
      x = (evt.touches[0].clientX - rect.left) * escalaX;
      y = (evt.touches[0].clientY - rect.top) * escalaY;
    } else {
      x = (evt.clientX - rect.left) * escalaX;
      y = (evt.clientY - rect.top) * escalaY;
    }
    return { x, y };
  }

  function startDraw(evt) {
    evt.preventDefault();
    drawing = true;
    const pos = getPos(evt);
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
  }

  function draw(evt) {
    if (!drawing) return;
    evt.preventDefault();
    const pos = getPos(evt);
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "black"; // negro para la firma
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
    window.userHasDrawn = true;
  }

  function endDraw(evt) {
    evt.preventDefault();
    drawing = false;
    ctx.beginPath();
  }

  // ✅ Eventos PC
  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", endDraw);
  canvas.addEventListener("mouseleave", endDraw);

  // ✅ Eventos móviles
  canvas.addEventListener("touchstart", startDraw, { passive: false });
  canvas.addEventListener("touchmove", draw, { passive: false });
  canvas.addEventListener("touchend", endDraw, { passive: false });
  canvas.addEventListener("touchcancel", endDraw, { passive: false });
});
</script>

<!-- Autocompletar -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const sugerencias = [
    "PUNTERA P/GOLPE DEL DER", "PUNTERA P/GOLPE DEL IZQ", "SEÑALERO DEL DER",
    "SEÑALERO DEL IZQ", "PUNTERA P/GOLPE TRAS DER", "PUNTERA P/GOLPE TRAS IZQ",
    "LUNETA TRASERA", "MOLDURA sup tapa caja", "FRENTE DE CHAPA",
    "PORTON LATERAL DERECHO", "CHORIZO DE TECHO IZQ"
  ];

  function aplicarAutocompletado(inputAuto) {
    let ultimaEntrada = "";
    inputAuto.addEventListener("input", () => {
      const valor = inputAuto.value.toLowerCase();
      if (valor.length < ultimaEntrada.length) {
        ultimaEntrada = valor;
        return;
      }
      const match = sugerencias.find(opcion => opcion.toLowerCase().startsWith(valor));
      if (match && valor !== match.toLowerCase()) {
        inputAuto.value = match;
        inputAuto.setSelectionRange(valor.length, match.length);
      }
      ultimaEntrada = valor;
    });
  }

  document.querySelectorAll(".autocomplete").forEach(aplicarAutocompletado);

  function agregarFilaSiEsUltima(input, tablaId) {
    const tabla = document.getElementById(tablaId);
    const filas = tabla.querySelectorAll("tbody tr");
    const ultimaFila = filas[filas.length - 1];

    if (ultimaFila.contains(input)) {
      const nuevaFila = ultimaFila.cloneNode(true);
      nuevaFila.querySelectorAll("input").forEach(input => input.value = "");
      tabla.querySelector("tbody").appendChild(nuevaFila);
      nuevaFila.querySelectorAll(".autocomplete").forEach(aplicarAutocompletado);
    }
  }

  function inicializarAutofila(tablaId) {
    const tabla = document.getElementById(tablaId);
    tabla.addEventListener("input", function (e) {
      if (e.target.tagName === "INPUT") {
        agregarFilaSiEsUltima(e.target, tablaId);
      }
    });
  }

  inicializarAutofila("tablaPiezas1");
  inicializarAutofila("tablaPiezas2");
});
</script>

<!-- Escalado automático -->
<script>
function escalarPagina() {
  const baseWidth = 1200;
  const escala = Math.min(window.innerWidth / baseWidth, 1);
  const escalado = document.getElementById('escalado');

  if (!escalado) return;

  escalado.style.transform = `scale(${escala})`;
  escalado.style.transformOrigin = 'top center';

  const altoEscalado = escalado.getBoundingClientRect().height;
  document.body.style.height = `${altoEscalado}px`;
}
window.addEventListener('resize', escalarPagina);
window.addEventListener('load', escalarPagina);
</script>

<!-- MSAL + Generación y subida del PDF a OneDrive (modificado con .modo-pdf) -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const boton = document.querySelector("#boton .boton"); 
  if (!boton) {
    console.error("❌ No se encontró el botón #boton .boton");
    return;
  }

  boton.addEventListener("click", async (e) => {
    e.preventDefault();

    const carpeta = (document.getElementById("carpeta") || {}).value?.trim() || "";
    const asegurado = (document.getElementById("asegurado") || {}).value?.trim() || "";
    const vehiculo = (document.getElementById("vehiculo") || {}).value?.trim() || "";
    const matricula = (document.getElementById("matricula") || {}).value?.trim() || "";
    const siniestro1 = (document.getElementById("siniestro1") || {}).value?.trim() || "";
    const siniestro2 = (document.getElementById("siniestro2") || {}).value?.trim() || "";
    const fechaInput = document.getElementById("fecha");
    const dificultadVisual = (document.getElementById("dificultadVisual") || {}).value?.trim() || "";

    if (!carpeta || !asegurado || !vehiculo || !matricula || !siniestro1 || !siniestro2) {
      alert("⚠️ Complete todos los campos antes de generar el PDF.");
      return;
    }
    
  
  const fechaDiv = document.getElementById("fecha");
  const hoy = new Date();

  // Array con los nombres de los meses en español (abreviados como "Setiembre")
  const meses = [
    "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
    "Julio", "Agosto", "Setiembre", "Octubre", "Noviembre", "Diciembre"
  ];

  const dia = hoy.getDate();
  const mes = meses[hoy.getMonth()];
  const anio = hoy.getFullYear();

  // Construir el texto
  fechaDiv.textContent = `${dia} de ${mes} de ${anio}`;

    const ok = confirm("¿El número de siniestro ingresado es correcto:" + siniestro1 + "-" + siniestro2 + "?");
    if (!ok) {
      fechaInput.style.display = "inline";
      fechaLabel.removeChild(spanFecha);
      return;
    }

    const element = document.getElementById("contenidoPDF");
    if (!element) {
      alert("❌ No se encontró el contenido a exportar (#contenidoPDF).");
      fechaInput.style.display = "inline";
      fechaLabel.removeChild(spanFecha);
      return;
    }

    try {
      // 1) Forzar estilos A4
      document.body.classList.add("modo-pdf");

      // 2) Generar PDF como Blob
      const opt = {
        margin: [0, 0, 0, 0],
        filename: `${siniestro1 || "Siniestro"}-${siniestro2 || ""}.pdf`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      };

      const blob = await html2pdf().set(opt).from(element).output('blob');

      // 3) Enviar al backend
      const nombreArchivo = `${siniestro1 || "Siniestro1"}_${siniestro2 || "Siniestro2"}_Formulario_1.pdf`;
      const formData = new FormData();
      formData.append('pdf', blob, nombreArchivo);
      formData.append('filename', nombreArchivo);
      formData.append("folder", "Formulario 1"); 
      
      const res = await fetch('https://extra-seguro-backend.onrender.com/upload', {
        method: 'POST',
        body: formData
      });

      if (res.ok) {
        const data = await res.json().catch(() => ({}));
        alert("✅ PDF enviado y subido correctamente");
        if (data?.webUrl) {
          console.log("🔗 Archivo en SharePoint/OneDrive:", data.webUrl);
        }
      } else {
        const text = await res.text().catch(() => "");
        alert("❌ Error al subir PDF: " + res.status + (text ? ` - ${text}` : ""));
      }
    } catch (err) {
      alert("❌ Error generando o subiendo el PDF: " + (err?.message || err));
    } finally {
      // 4) Restaurar UI
      document.body.classList.remove("modo-pdf");
      fechaInput.style.display = "inline";
      fechaLabel.removeChild(spanFecha);
    }
  });
});
</script>
</body>
</html>
